<style>
	.cd-popup-automation {
  position: fixed;
  left: 0;
  top: 0;
  height: 100%;
  width: 100%;
  background-color: rgba(85, 89, 96, 0.37);
  opacity: 0;
  visibility: hidden;
  z-index: 99999999;
  -webkit-transition: opacity 0.3s 0s, visibility 0s 0.3s;
  -moz-transition: opacity 0.3s 0s, visibility 0s 0.3s;
  transition: opacity 0.3s 0s, visibility 0s 0.3s;
}
.cd-popup-automation.is-visible {
  opacity: 1;
  visibility: visible;
  -webkit-transition: opacity 0.3s 0s, visibility 0s 0s;
  -moz-transition: opacity 0.3s 0s, visibility 0s 0s;
  transition: opacity 0.3s 0s, visibility 0s 0s;
}
.automated{
	color:green;
}
/* Notification dropdown */
#notif-dropdown {
	display: none;
	position: absolute;
	right: 0;
	top: 100%;
	min-width: 340px;
	max-height: 400px;
	overflow-y: auto;
	background: #fff;
	border-radius: 8px;
	box-shadow: 0 4px 20px rgba(0,0,0,0.15);
	z-index: 9999;
	padding: 10px 0;
	list-style: none;
}
#notif-dropdown.show {
	display: block;
}
#notif-bell-container {
	position: relative;
}
</style>
<script>

	$('body').on('click','.cd-popup-trigger-automation', function(event){
		event.preventDefault();
		$('.cd-popup-automation').addClass('is-visible');
	});
	
	$('body').on('click','.cd-popup-close-atomation', function(event){
		event.preventDefault();
		$('.cd-popup-automation').removeClass('is-visible');
	});
	$('body').on('click','.cd-popup-automation', function(event){
		if( $(event.target).is('.cd-popup-close-atomation') || $(event.target).is('.cd-popup-automation') ||  $(event.target).is('.cd-popup-close2')  ) {
			
			$(this).removeClass('is-visible');
			try{
				
					$(".complete-schedule").addClass('logout-btn')
					$(".complete-schedule").removeClass('complete-schedule')
					$("#logout-popup-title").text('Are you sure you want to logout')
				
			}catch(err){
				console.log(err)
			}
			
		}
	});
	$('body').on('click','.automate_btn', function(event){
		event.preventDefault();
		if($(".automation-select").val()!="0"){
			$.ajax({
				url:"/automation/automate?parameter="+$(".automation-select").val(),
				success:function(data){
					if(data=='stopped'){
						$(".cd-popup-trigger-automation").removeClass("automated")
					}else{
						$(".cd-popup-trigger-automation").addClass("automated")
					}
					alert("Automation "+data)
					
				},error:function(err){
					
				}
			})
		}
	});
</script>
<nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl me-0" id="navbarBlur" data-scroll="true">
      <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
        <ul class="navbar-nav2 d-flex row mb-0 px-0 hstack justify-content-end">
            
            <li class="nav-item2 d-none xl-sidebar d-xl-flex  ps-3  align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav2">
                <div class="sidenav-toggler-inner2">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>
        </ul>
                  </nav>
        <div class="collapse navbar-collapse mt-sm-0 mt-2 me-md-0 me-sm-4" id="navbar">
       
          <div class="ms-md-auto pe-md-0 d-flex align-items-center">
           
            <div class="input-group input-group-outline">
              <label class="form-label">Type here...</label>
              <input type="text" id="search-box" class="form-control">
            </div>
            <div class="mx-2 btn cd-popup-trigger-automation my-0" th:classappend="${isAutomated?'automated':''}" th:if="${role == 'manager' || role=='admin'}">
       		 automate	
       	 </div>
          </div>
          <ul class="navbar-nav  justify-content-end">

            <!-- Notification Bell -->
            <li class="nav-item dropdown pe-2 d-flex align-items-center" id="notif-bell-container">
              <a href="javascript:;" class="nav-link text-body p-0 position-relative" id="notifBellDropdown">
                <i class="material-icons opacity-10">notifications</i>
                <span class="badge bg-danger badge-sm position-absolute top-0 start-100 translate-middle rounded-pill d-none" id="notif-badge">0</span>
              </a>
              <ul class="px-2 py-3" id="notif-dropdown">
                <li class="mb-2 px-2 d-flex justify-content-between align-items-center">
                  <h6 class="mb-0">Notifications</h6>
                  <a href="javascript:;" class="text-xs text-primary" id="mark-all-read-btn">Mark all read</a>
                </li>
                <li><hr class="dropdown-divider my-1"></li>
                <div id="notif-list">
                  <li class="px-2 py-2 text-center text-xs text-muted">No new notifications</li>
                </div>
              </ul>
            </li>

            <li class="nav-item d-xl-none ps-3 d-flex align-items-center">
              <a href="javascript:;" class="nav-link text-body p-0" id="iconNavbarSidenav">
                <div class="sidenav-toggler-inner">
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                  <i class="sidenav-toggler-line"></i>
                </div>
              </a>
            </li>
          
            
          </ul>
        </div>
      </div>
      
      <div class="cd-popup-automation" role="alert">
	<div class="cd-popup-container text-dark">
			<div class="card-header text-lg py-2" style="background: #e3e3e3;border-radius: 5px 5px 0px 0px;">Select Parameter</div>
		<select class="automation-select my-3 w-80" >
			<option value="0" id="0">Select Paramater</option>
			<option value="Remove" >Stop Automation
			</option>
			<option value="Random" >Start Automation
			</option>
		</select>
		<ul class="cd-buttons ps-0">
			<li><a  class=" cd-popup-close-atomation">Cancel</a></li>
			<li><a  class="cd-popup-close-atomation automate_btn">Automate</a></li>
		</ul>
		<a href="#0" class="cd-popup-close cd-popup-close-atomation img-replace">Close</a>
	</div> <!-- cd-popup-container -->
</div>
    </nav>

<script>
// Notification Bell Logic
function loadNotificationCount() {
	$.ajax({
		url: '/api/notifications/count',
		type: 'GET',
		success: function(data) {
			var count = data.count || 0;
			if (count > 0) {
				$('#notif-badge').text(count).removeClass('d-none');
			} else {
				$('#notif-badge').addClass('d-none');
			}
		}
	});
}

function loadNotifications() {
	$.ajax({
		url: '/api/notifications/unread',
		type: 'GET',
		success: function(data) {
			var html = '';
			if (data && data.length > 0) {
				for (var i = 0; i < data.length; i++) {
					var n = data[i];
					var icon = n.type === 'COUNSELLED' ? 'record_voice_over' : (n.type === 'CLOSED' ? 'lock' : 'task_alt');
					var color = n.type === 'COUNSELLED' ? 'text-info' : (n.type === 'CLOSED' ? 'text-warning' : 'text-success');
					var timeAgo = formatTimeAgo(n.createdOn);
					html += '<li class="px-2 py-2 border-bottom">' +
						'<div class="d-flex align-items-start">' +
						'<i class="material-icons ' + color + ' me-2 mt-1" style="font-size:18px;">' + icon + '</i>' +
						'<div>' +
						'<p class="mb-0 text-sm">' + n.message + '</p>' +
						'<span class="text-xs text-muted">' + timeAgo + '</span>' +
						'</div>' +
						'</div></li>';
				}
			} else {
				html = '<li class="px-2 py-2 text-center text-xs text-muted">No new notifications</li>';
			}
			$('#notif-list').html(html);
		}
	});
}

function formatTimeAgo(dateStr) {
	if (!dateStr) return '';
	var date = new Date(dateStr);
	var now = new Date();
	var diff = Math.floor((now - date) / 1000);
	if (diff < 60) return 'Just now';
	if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
	if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
	return Math.floor(diff / 86400) + 'd ago';
}

$(document).ready(function() {
	loadNotificationCount();
	// Refresh count every 30 seconds
	setInterval(loadNotificationCount, 30000);

	// Toggle dropdown when bell is clicked
	$('body').on('click', '#notifBellDropdown', function(e) {
		e.preventDefault();
		e.stopPropagation();
		var dropdown = $('#notif-dropdown');
		if (dropdown.hasClass('show')) {
			dropdown.removeClass('show');
		} else {
			loadNotifications();
			dropdown.addClass('show');
		}
	});

	// Close dropdown when clicking outside
	$(document).on('click', function(e) {
		if (!$(e.target).closest('#notif-bell-container').length) {
			$('#notif-dropdown').removeClass('show');
		}
	});

	// Mark all as read
	$('body').on('click', '#mark-all-read-btn', function(e) {
		e.preventDefault();
		e.stopPropagation();
		$.ajax({
			url: '/api/notifications/mark-read',
			type: 'PUT',
			success: function() {
				$('#notif-badge').addClass('d-none');
				$('#notif-list').html('<li class="px-2 py-2 text-center text-xs text-muted">No new notifications</li>');
			}
		});
	});
});
</script>